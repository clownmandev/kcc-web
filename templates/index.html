<!DOCTYPE html>
<html lang="en">
<head>
    <title>KCC Web v3.0</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 20px auto; background: #eee; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px; background: #ddd; cursor: pointer; border-radius: 4px; }
        .tab.active { background: #007bff; color: white; }
        .section { display: none; }
        .section.active { display: block; }
        #log-window { background: #000; color: #0f0; height: 300px; overflow-y: auto; padding: 10px; font-family: monospace; margin-top: 20px; }
        .input-row { margin-bottom: 10px; display: flex; gap: 10px; }
        input, select { padding: 8px; flex: 1; }
        button { padding: 10px; background: #28a745; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="card">
        <h1>KCC Suite v3.0 <small style="font-size: 12px; color: #888;">(Everything Restored)</small></h1>
        <div class="tabs">
            <div class="tab active" onclick="setTab('mangadex')">Mangadex</div>
            <div class="tab" onclick="setTab('local')">Local PDF/ZIP</div>
            <div class="tab" onclick="setTab('scraper')">URL Scraper</div>
        </div>

        <div id="mangadex" class="section active">
            <div class="input-row"><input type="text" id="query" placeholder="Search Manga..."><button onclick="search()">Search</button></div>
            <div id="results"></div>
            <div id="dex-options" style="display:none; margin-top:10px; background:#f9f9f9; padding:10px;">
                <span id="sel-title"></span>
                <div class="input-row">
                    <input type="number" id="v-start" value="1" placeholder="Vol Start">
                    <input type="number" id="v-end" value="1" placeholder="Vol End">
                </div>
                <div class="input-row">
                    <input type="number" id="c-start" placeholder="Chap Start (Opt)">
                    <input type="number" id="c-end" placeholder="Chap End (Opt)">
                </div>
            </div>
        </div>

        <div id="local" class="section">
            <input type="file" id="file-input"><button onclick="uploadFile()">Upload</button>
            <p id="upload-status"></p>
        </div>

        <div id="scraper" class="section">
            <input type="text" id="scrap-url" placeholder="Paste Chapter URL (Mangabat, etc.)" style="width:100%;">
        </div>

        <hr>
        <div class="input-row">
            <select id="profile"><option value="KPW">Kindle Paperwhite</option><option value="KV">Kindle Oasis/Voyage</option></select>
            <select id="format"><option value="EPUB">EPUB</option><option value="MOBI">MOBI</option></select>
        </div>
        <button onclick="startJob()" style="width:100%; background:#007bff;">START CONVERSION</button>

        <div id="log-window">Logs...</div>
        <div id="dl-link" style="display:none; text-align:center; padding:20px; background:#d4edda; margin-top:10px;"></div>
    </div>

    <script>
        let mode = 'mangadex'; let selectedId = ''; let selectedTitle = ''; let localFile = '';
        function setTab(t) { 
            mode = t; 
            document.querySelectorAll('.tab, .section').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab[onclick="setTab('${t}')"]`).classList.add('active');
            document.getElementById(t).classList.add('active');
        }

        async function search() {
            const res = await fetch('/api/search', { method: 'POST', body: new URLSearchParams({query: document.getElementById('query').value}) });
            const data = await res.json();
            document.getElementById('results').innerHTML = data.map(m => `<div onclick="selectM('${m.id}','${m.title}')" style="cursor:pointer; padding:5px; border-bottom:1px solid #eee;">${m.title}</div>`).join('');
        }

        function selectM(id, title) {
            selectedId = id; selectedTitle = title;
            document.getElementById('sel-title').innerText = "Selected: " + title;
            document.getElementById('dex-options').style.display = 'block';
        }

        async function uploadFile() {
            const fd = new FormData(); fd.append('file', document.getElementById('file-input').files[0]);
            const res = await fetch('/api/upload', { method: 'POST', body: fd });
            const data = await res.json();
            localFile = data.filename;
            document.getElementById('upload-status').innerText = "Uploaded: " + localFile;
        }

        async function startJob() {
            const fd = new URLSearchParams({
                mode: mode, profile: document.getElementById('profile').value, format: document.getElementById('format').value,
                manga_id: selectedId, manga_title: selectedTitle,
                vol_start: document.getElementById('v-start').value, vol_end: document.getElementById('v-end').value,
                chap_start: document.getElementById('c-start').value, chap_end: document.getElementById('c-end').value,
                filename: localFile, chapter_url: document.getElementById('scrap-url').value
            });
            const res = await fetch('/api/start_job', { method: 'POST', body: fd });
            const data = await res.json();
            poll(data.job_id);
        }

        function poll(id) {
            const interval = setInterval(async () => {
                const res = await fetch('/api/job_status/' + id);
                const data = await res.json();
                document.getElementById('log-window').innerText = data.logs.join('\n');
                if(data.status === 'finished') {
                    clearInterval(interval);
                    document.getElementById('dl-link').style.display = 'block';
                    document.getElementById('dl-link').innerHTML = `<a href="/download_file/${data.result}">DOWNLOAD SUCCESS: ${data.result}</a>`;
                }
            }, 1000);
        }
    </script>
</body>
</html>

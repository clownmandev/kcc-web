<!DOCTYPE html>
<html lang="en">
<head>
    <title>KCC Suite v5.1</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 20px auto; background: #f0f2f5; }
        .card { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .section { display: none; padding: 15px 0; }
        .section.active { display: block; }
        #log-window { background: #1a1a1a; color: #33ff33; height: 350px; overflow-y: auto; padding: 15px; font-family: monospace; border-radius: 8px; margin-top: 20px; font-size: 13px; white-space: pre-wrap; }
        input, select, button { padding: 12px; border: 1px solid #ddd; border-radius: 6px; }
        .btn-blue { background: #007bff; color: white; border: none; width: 100%; font-weight: bold; cursor: pointer; }
        .manga-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 10px; margin-top: 15px; }
        .manga-card { border: 1px solid #eee; padding: 5px; text-align: center; cursor: pointer; }
        .manga-card img { width: 100%; height: 160px; object-fit: cover; }
        .checkbox-row { background: #e9ecef; padding: 10px; border-radius: 6px; margin: 10px 0; display: flex; align-items: center; gap: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="card">
        <h1>KCC Suite v5.1</h1>
        
        <div id="mangadex">
            <div style="display:flex; gap:10px;"><input type="text" id="query" style="flex:1" placeholder="Search Manga..."><button onclick="search()">Search</button></div>
            <div id="results" class="manga-grid"></div>
            <div id="dex-options" style="display:none; margin-top:20px;">
                <h3 id="sel-title"></h3>
                <div class="checkbox-row">
                    <input type="checkbox" id="combine" checked> <label for="combine">Combine everything into 1 single file</label>
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="number" id="v-start" value="1"> <input type="number" id="v-end" value="1">
                    <input type="number" id="c-start" placeholder="Chap Start"> <input type="number" id="c-end" placeholder="Chap End">
                </div>
            </div>
        </div>

        <div style="margin-top:20px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <select id="profile"><option value="KPW">Kindle Paperwhite</option></select>
                <select id="format"><option value="EPUB">EPUB</option><option value="MOBI">MOBI</option></select>
            </div>
            <button class="btn-blue" onclick="startJob()">START CONVERSION</button>
        </div>

        <div id="log-window">Logs...</div>
        <div id="dl-link" style="display:none; margin-top:10px; padding:20px; background:#d4edda; text-align:center; border-radius:8px;"></div>
    </div>

    <script>
        let selectedId = ''; let selectedTitle = '';
        async function search() {
            const res = await fetch('/api/search', { method: 'POST', body: new URLSearchParams({query: document.getElementById('query').value}) });
            const data = await res.json();
            document.getElementById('results').innerHTML = data.map(m => `
                <div class="manga-card" onclick="selectM('${m.id}','${m.title.replace(/'/g, "\\'")}')">
                    <img src="${m.cover}"><br><b>${m.title}</b>
                </div>`).join('');
        }
        async function selectM(id, title) {
            selectedId = id; selectedTitle = title;
            document.getElementById('sel-title').innerText = "Selected: " + title;
            document.getElementById('dex-options').style.display = 'block';
            const res = await fetch('/api/manga_details', { method: 'POST', body: new URLSearchParams({manga_id: id}) });
            const data = await res.json();
            document.getElementById('v-end').value = data.total_volumes || 1;
        }
        async function startJob() {
            const fd = new URLSearchParams({
                mode: 'mangadex', manga_id: selectedId, manga_title: selectedTitle,
                combine: document.getElementById('combine').checked,
                vol_start: document.getElementById('v-start').value, vol_end: document.getElementById('v-end').value,
                chap_start: document.getElementById('c-start').value, chap_end: document.getElementById('c-end').value,
                profile: document.getElementById('profile').value, format: document.getElementById('format').value
            });
            const res = await fetch('/api/start_job', { method: 'POST', body: fd });
            const data = await res.json();
            poll(data.job_id);
        }
        function poll(id) {
            const interval = setInterval(async () => {
                const res = await fetch('/api/job_status/' + id);
                const data = await res.json();
                document.getElementById('log-window').innerText = data.logs.join('\n');
                document.getElementById('log-window').scrollTop = document.getElementById('log-window').scrollHeight;
                if(data.status === 'finished') {
                    clearInterval(interval);
                    document.getElementById('dl-link').style.display = 'block';
                    document.getElementById('dl-link').innerHTML = `<a href="/download_file/${data.result}">DOWNLOAD: ${data.result}</a>`;
                }
            }, 1000);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <title>KCC Suite v4.0</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 20px auto; background: #f0f2f5; }
        .card { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .tab { padding: 10px 20px; cursor: pointer; border-radius: 6px; font-weight: bold; color: #555; }
        .tab.active { background: #007bff; color: white; }
        .section { display: none; padding: 15px 0; }
        .section.active { display: block; }
        #log-window { background: #1a1a1a; color: #33ff33; height: 350px; overflow-y: auto; padding: 15px; font-family: 'Courier New', monospace; border-radius: 8px; margin-top: 20px; font-size: 13px; line-height: 1.4; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-blue { background: #007bff; color: white; width: 100%; margin-top: 20px; font-size: 16px; }
        .btn-green { background: #28a745; color: white; }
        .manga-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .manga-card { border: 1px solid #eee; padding: 10px; text-align: center; cursor: pointer; border-radius: 8px; }
        .manga-card:hover { border-color: #007bff; background: #f0f7ff; }
        .manga-card img { width: 100%; height: 180px; object-fit: cover; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="card">
        <h1>KCC Suite <span style="color:#007bff">v4.0</span></h1>
        <div class="tabs">
            <div class="tab active" onclick="setTab('mangadex')">MangaDex</div>
            <div class="tab" onclick="setTab('local')">Local Files</div>
            <div class="tab" onclick="setTab('scraper')">Universal Scraper</div>
        </div>

        <div id="mangadex" class="section active">
            <div style="display:flex; gap:10px;"><input type="text" id="query" style="flex:1" placeholder="Search Manga..."><button class="btn btn-green" onclick="search()">Search</button></div>
            <div id="results" class="manga-grid"></div>
            <div id="dex-options" style="display:none; margin-top:20px; padding:15px; background:#f8f9fa; border-radius:8px;">
                <h3 id="sel-title"></h3>
                <p id="sel-stats" style="color:#666;"></p>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                    <input type="number" id="v-start" value="1" placeholder="Vol Start">
                    <input type="number" id="v-end" value="1" placeholder="Vol End">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <input type="number" id="c-start" placeholder="Chap Start (Optional)">
                    <input type="number" id="c-end" placeholder="Chap End (Optional)">
                </div>
            </div>
        </div>

        <div id="local" class="section">
            <input type="file" id="file-input" style="width:100%"><br><br>
            <button class="btn btn-green" onclick="uploadFile()">Upload File</button>
            <p id="upload-status" style="font-weight:bold; color:#28a745;"></p>
        </div>

        <div id="scraper" class="section">
            <input type="text" id="scrap-url" placeholder="Paste URL (Mangabat, Mangakakalot, etc.)" style="width:100%;">
            <p style="font-size:12px; color:#888; margin-top:5px;">Note: You can use Volume/Chapter filters here too if the site supports them.</p>
        </div>

        <div style="margin-top:20px; border-top:1px solid #eee; padding-top:20px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <select id="profile"><option value="KPW">Kindle Paperwhite</option><option value="KV">Kindle Oasis/Voyage</option></select>
                <select id="format"><option value="EPUB">EPUB</option><option value="MOBI">MOBI</option><option value="AZW3">AZW3</option></select>
            </div>
            <button class="btn btn-blue" onclick="startJob()">START CONVERSION</button>
        </div>

        <div id="log-window">Logs will appear here when processing starts...</div>
        <div id="dl-link" style="display:none; text-align:center; padding:25px; background:#d4edda; margin-top:15px; border-radius:8px; border:2px dashed #28a745;"></div>
    </div>

    <script>
        let mode = 'mangadex'; let selectedId = ''; let selectedTitle = ''; let localFile = '';
        function setTab(t) { 
            mode = t; 
            document.querySelectorAll('.tab, .section').forEach(el => el.classList.remove('active'));
            document.querySelector(`.tab[onclick="setTab('${t}')"]`).classList.add('active');
            document.getElementById(t).classList.add('active');
        }

        async function search() {
            const res = await fetch('/api/search', { method: 'POST', body: new URLSearchParams({query: document.getElementById('query').value}) });
            const data = await res.json();
            document.getElementById('results').innerHTML = data.map(m => `
                <div class="manga-card" onclick="selectM('${m.id}','${m.title.replace(/'/g, "\\'")}')">
                    <img src="${m.cover}">
                    <div style="font-size:12px; margin-top:5px; font-weight:bold;">${m.title}</div>
                </div>`).join('');
        }

        async function selectM(id, title) {
            selectedId = id; selectedTitle = title;
            document.getElementById('sel-title').innerText = title;
            document.getElementById('dex-options').style.display = 'block';
            const res = await fetch('/api/manga_details', { method: 'POST', body: new URLSearchParams({manga_id: id}) });
            const data = await res.json();
            document.getElementById('sel-stats').innerText = `${data.total_chapters} Chapters found in ${data.total_volumes} Volumes`;
            document.getElementById('v-end').value = data.total_volumes || 1;
        }

        async function uploadFile() {
            const fd = new FormData(); fd.append('file', document.getElementById('file-input').files[0]);
            const res = await fetch('/api/upload', { method: 'POST', body: fd });
            const data = await res.json();
            localFile = data.filename;
            document.getElementById('upload-status').innerText = "âœ“ Uploaded: " + localFile;
        }

        async function startJob() {
            const fd = new URLSearchParams({
                mode: mode, profile: document.getElementById('profile').value, format: document.getElementById('format').value,
                manga_id: selectedId, manga_title: selectedTitle,
                vol_start: document.getElementById('v-start').value, vol_end: document.getElementById('v-end').value,
                chap_start: document.getElementById('c-start').value, chap_end: document.getElementById('c-end').value,
                filename: localFile, url: document.getElementById('scrap-url').value
            });
            const res = await fetch('/api/start_job', { method: 'POST', body: fd });
            const data = await res.json();
            document.getElementById('dl-link').style.display = 'none';
            poll(data.job_id);
        }

        function poll(id) {
            const interval = setInterval(async () => {
                const res = await fetch('/api/job_status/' + id);
                const data = await res.json();
                document.getElementById('log-window').innerText = data.logs.join('\n');
                document.getElementById('log-window').scrollTop = document.getElementById('log-window').scrollHeight;
                if(data.status === 'finished') {
                    clearInterval(interval);
                    document.getElementById('dl-link').style.display = 'block';
                    document.getElementById('dl-link').innerHTML = `<a href="/download_file/${data.result}" style="color:#155724; font-size:18px; font-weight:bold; text-decoration:none;">ðŸ“¥ DOWNLOAD: ${data.result}</a>`;
                } else if (data.status === 'failed') { clearInterval(interval); alert("Job Failed. Check logs."); }
            }, 1000);
        }
    </script>
</body>
</html>
